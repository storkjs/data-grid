<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">

	<link rel="stylesheet" type="text/css" href="../dist/data-grid.min.css">
	<link rel="stylesheet" type="text/css" href="../dist/simple-theme.min.css">

	<script src="../bower_components/stork-shims/dist/shims.min.js"></script>
	<script src="../dist/data-grid.min.js"></script>

	<style type="text/css">
		* {
			box-sizing: border-box;
		}
		html, body {
			height: 100%;
		}
		body {
			margin: 0;
			display: flex;
			justify-content: center;
			align-items: center;
		}
		#parentDiv {
			height: 100%;
			width: 100%;
			position: relative;
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
		}
		#grid {
			width: 980px;
			height: 870px;
		}

		.opButtons {
			display: flex;
			justify-content: space-between;
			align-items: flex-start;

			width: 440px;
			padding-bottom: 10px;
		}

		span.color1, span.color2, span.color3, span.color4, span.color5, span.color6 { font-weight: bold; }
		span.color1 { color: #00aa00; }
		span.color2 { color: #aa0000; }
		span.color3 { color: #0000aa; }
		span.color4 { color: #aaaa00; }
		span.color5 { color: #00aaaa; }
		span.color6 { color: #aa00aa; }
	</style>

	<script src="data.js"></script>
	<script>
		loadBulk(1000);

		var testGrid, almostHitTop;

		var sortColumn = function sortColumn(column, state) {
			return function(a, b) {
				if(state === null && a.id) {
					column = 'id';
					state = 'ascending';
				}
				if (a[column] < b[column])
					return (state === 'ascending' ? 1 : -1);
				if (a[column] > b[column])
					return (state === 'ascending' ? -1 : 1);
				return 0;
			}
		};

		document.addEventListener("DOMContentLoaded", function(e) {
			document.getElementById('grid').addEventListener('grid-loaded', function(e) {
				e.detail.gridObj.scrollY += 500;
			}, { capture: false });

			testGrid = new storkGrid({
				element: document.getElementById('grid'),
				data: window.bigData,
				rowHeight: 30,
				headerHeight: 50,
				sortable: true,
				selection: {
					multi: true,
					type: 'row'
				},
				columns: [
					{ dataName: 'id', displayName: 'ID', width: 70, fixed: true },
					{ dataName: 'country', displayName: 'Country', width: 110, minWidth: 70 },
					{ dataName: 'city', displayName: 'City', width: 115, minWidth: 75, fixed: true },
					{ dataName: 'animal', displayName: 'Animal', width: 110 },
					{ dataName: 'plant', displayName: 'Plant', width: 120, render: function(tdDiv, value) {
						if(value.toLowerCase() === 'tulip') {
							tdDiv.innerHTML = '<span class="color'+Math.floor(Math.random() * 6 + 1)+'">' + value + '</span>';
						} else {
							tdDiv.innerHTML = value;
						}
					} },
					{ dataName: 'inanimate', displayName: 'Inanimate', width: 125 },
					{ dataName: 'boy', displayName: 'Boy' },
					{ dataName: 'girl', displayName: 'Girl' },
					{ dataName: 'random_float', displayName: 'Big Num', width: 150 },
					{ dataName: 'random_integer', displayName: 'Small Num', width: 150 }
				],
				minColumnWidth: 65,
				resizableColumns: true,
				trackBy: 'id',
				onload: function(e) { // another way to add onLoad listener
					e.detail.gridObj.scrollY += 2000;
				}
			});

			testGrid.addEventListener('select', function(e) {
				console.log('select: ', e.detail);
			}, false);
			testGrid.addEventListener('dblselect', function(e) {
				console.log('double select: ', e.detail);
			}, false);

			testGrid.addScrollEvent('almostHitBottom', 100); // when to emit
			testGrid.addEventListener('almostHitBottom', function(e) {
				var dataLength = testGrid.data.length;
				loadBulk(4000);
				if(testGrid.data.length > dataLength) {
					testGrid.refresh();
				}
			}, false);

			var forceRefresh = false;
			var loadedDataTO;
			testGrid.addScrollEvent('almostHitTop', 100, false); // when to emit
			almostHitTop = function(e) {
				var dataLength = testGrid.data.length;
				loadBulk(900, true);
				if(testGrid.data.length > dataLength) {
					testGrid.scrollY += 1200;
					forceRefresh = true;
					clearTimeout(loadedDataTO);
					loadedDataTO = setTimeout(function() { forceRefresh = false; }, 500);
				}

				// will keep refreshing the view on each scroll up, for 500ms since last successful 'loadBulk'.
				// this solves a bug when user drags the scrollbar up and the browser keeps emitting 'scrollTop=0'
				if(forceRefresh) {
					testGrid.refresh();
				}
			};
			testGrid.addEventListener('almostHitTop', almostHitTop, false);

			testGrid.addEventListener('sort', function(e) {
				testGrid.data.sort(sortColumn(e.detail.column, e.detail.state));
				testGrid.refresh();
			}, false);

			testGrid.addEventListener('resize-column', function(e) {
				console.log(e.detail);
			}, false);
		});

		var destroyGrid = function destroyGrid() {
			if(testGrid) {
				testGrid.destroy();
			}
		};

		var rearrange = function rearrange() {
			if(testGrid && testGrid.grid) {
				testGrid.setColumns([
					{dataName: 'eretz', displayName: 'Eretz', width: 110, minWidth: 70, fixed: true},
					{dataName: 'reg-amount', displayName: 'Reg Amount', width: 110, fixed: true},
					{dataName: 'other_amount', displayName: 'Other Amount', width: 110},
					{dataName: 'eer', displayName: 'Eer', width: 115, minWidth: 75},
					{dataName: 'id', displayName: 'ID', width: 70}
				]);
			}
		};

		var removeInfiniteTopScroll = function removeInfiniteTopScroll() {
			testGrid.removeEventListener('almostHitTop', almostHitTop, false);
		};
	</script>
</head>
<body>
<div id="parentDiv">
	<div class="opButtons">
		<button class="destroy-grid" onclick="destroyGrid();">Destroy grid</button>
		<button class="rearrange-cols" onclick="rearrange();">Rearrange columns</button>
		<button class="remove-scroll-event" onclick="removeInfiniteTopScroll();">Disable infinite top scroll</button>
	</div>
	<div id="grid"></div>
</div>
</body>
</html>